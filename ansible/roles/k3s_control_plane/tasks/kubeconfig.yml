---
# Kubeconfig management tasks

- name: Ensure kubeconfig exists
  ansible.builtin.stat:
    path: "{{ kubeconfig_path }}"
  register: kubeconfig_file

- name: Fail if kubeconfig not found
  ansible.builtin.fail:
    msg: "Kubeconfig file not found at {{ kubeconfig_path }}"
  when: not kubeconfig_file.stat.exists

- name: Read kubeconfig content
  ansible.builtin.slurp:
    src: "{{ kubeconfig_path }}"
  register: kubeconfig_content

- name: Parse kubeconfig
  ansible.builtin.set_fact:
    kubeconfig_data: "{{ kubeconfig_content.content | b64decode | from_yaml }}"

- name: Update kubeconfig server URL to use Tailscale IP
  ansible.builtin.set_fact:
    kubeconfig_updated: >-
      {{ kubeconfig_data | combine({
        'clusters': [
          kubeconfig_data.clusters[0] | combine({
            'cluster': kubeconfig_data.clusters[0].cluster | combine({
              'server': 'https://' + tailscale_ip + ':' + (api_server_port | string)
            })
          })
        ]
      }, recursive=True) }}

- name: Write updated kubeconfig
  ansible.builtin.copy:
    content: "{{ kubeconfig_updated | to_nice_yaml }}"
    dest: "{{ kubeconfig_path }}"
    mode: '0644'
    owner: root
    group: root

- name: Fetch kubeconfig to local machine
  ansible.builtin.fetch:
    src: "{{ kubeconfig_path }}"
    dest: "/tmp/{{ cluster_name }}-kubeconfig"
    flat: true

- name: Display kubeconfig location
  ansible.builtin.debug:
    msg: "Kubeconfig saved to /tmp/{{ cluster_name }}-kubeconfig on the Ansible controller"
