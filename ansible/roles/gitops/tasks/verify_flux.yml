---
# Tasks to verify Flux installation and configuration

- name: Run Flux check
  ansible.builtin.command:
    cmd: "{{ flux_install_dir }}/flux check"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: flux_check
  changed_when: false

- name: Display Flux check results
  ansible.builtin.debug:
    msg: "{{ flux_check.stdout_lines }}"

- name: Get Flux system status
  ansible.builtin.command:
    cmd: "{{ flux_install_dir }}/flux get all --namespace={{ flux_namespace | default(default_flux_namespace) }}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: flux_status
  changed_when: false

- name: Display Flux system status
  ansible.builtin.debug:
    msg: "{{ flux_status.stdout_lines }}"

- name: Verify GitRepository source is ready
  ansible.builtin.command:
    cmd: kubectl get gitrepository flux-system -n {{ flux_namespace | default(default_flux_namespace) }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: git_source_ready
  changed_when: false
  retries: 5
  delay: 10
  until: git_source_ready.stdout == "True"
  failed_when: false

- name: Display GitRepository source status
  ansible.builtin.debug:
    msg: "GitRepository source ready: {{ git_source_ready.stdout }}"

- name: Verify Kustomization is ready
  ansible.builtin.command:
    cmd: kubectl get kustomization flux-system -n {{ flux_namespace | default(default_flux_namespace) }} -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: kustomization_ready
  changed_when: false
  retries: 5
  delay: 10
  until: kustomization_ready.stdout == "True"
  failed_when: false

- name: Display Kustomization status
  ansible.builtin.debug:
    msg: "Kustomization ready: {{ kustomization_ready.stdout }}"

- name: Summary of Flux configuration
  ansible.builtin.debug:
    msg:
      - "Flux CD has been successfully installed and configured"
      - "Namespace: {{ flux_namespace | default(default_flux_namespace) }}"
      - "Git Repository: {{ git_repo_url }}"
      - "Branch: {{ git_branch }}"
      - "Path: {{ git_path }}"
      - "Reconcile Interval: {{ flux_reconcile_interval }}"
      - ""
      - "To view Flux status, run: flux get all -n {{ flux_namespace | default(default_flux_namespace) }}"
      - "To reconcile immediately, run: flux reconcile source git flux-system"
